<!DOCTYPE html>
<html lang="en">
	<head>
		<title>分片上传</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	</head>
	<body>
		<form>
			<input type="file" id="fileInput" multiple>
			<button type="button" onclick="upload()">上传</button>
		</form>
		<script>
            function upload() {
                var fileInput = document.getElementById('fileInput');
                var fileName = fileInput.files[0].name;
                var files = fileInput.files;
                console.log(files)
                // var chunkSize = 1024 * 10; // 每个块的大小为10KB
                var chunkSize = 1024 * 1024 * 8; // 每个块的大小为8mb
                var totalChunks = Math.ceil(files[0].size / chunkSize); // 文件总块数(一定向上取证)
                var currentChunk = 0; // 当前块数
                // 开始上传
                uploadChunk();

                // 分片上传文件
                function uploadChunk() {
                    var formData = new FormData();
                    formData.append('currentChunk', currentChunk);
                    formData.append('totalChunks', totalChunks);
                    formData.append('fileName', fileName);
                    var start = currentChunk * chunkSize;
                    var end = Math.min(files[0].size, start + chunkSize);//end一定要取最小值
                    var chunk = files[0].slice(start, end);   //为什么file可以用Blob的slice方法?
                    formData.append('chunk', chunk);
                    $.ajax({
                        type: 'POST',
                        url: 'http://localhost:8080/file/chunkUpload',
                        data: formData,
                        processData: false, // 不对数据进行处理
                        contentType: false, // 不设置内容类型
                        success: function (data) {
                            currentChunk++;
                            if (currentChunk < totalChunks) {
                                uploadChunk();
                            } else {
                                mergeChunks(fileName);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('上传失败: ' + error);
                        }
                    });
                }

                function mergeChunks() {
                    $.ajax({
                        type: 'POST',
                        url: 'http://localhost:8080/file/chunkMerge',
                        data: 'fileName=' + fileName, // 发送的数据
                        success: function (data) {
                            console.log('文件上传完成：' + data);
                        },
                        error: function (xhr, status, error) {
                            console.error('文件合并失败: ' + error);
                        }
                    });
                }
            }
		</script>
	</body>
</html>
